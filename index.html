<html>
    <head>
        <script>
var mainDiv = document.registerElement('main-div');
var contentDiv = document.registerElement('content-div');
/* squareType="I(nit),F(lag),S(afe),D(ead),W(rong),R(ight),U(nfound),1,2,3,4..." */
var subSquare = document.registerElement('sub-square', class extends HTMLElement {
    //createdCallback() {};
    attachedCallback() {
        this.shadow = this.createShadowRoot();
        this.setAttribute("square-type","I");
    };
    //detachedCallback() {};
    attributeChangedCallback(attr, oldVal, newVal) {
        if(attr=="square-type"){
            this.shadow.innerHTML = "";
            var squareType = "";
            this.innerHTML = newVal;
            switch(newVal){
                case "I":
                    squareType="sub-init";
                    break;
                case "F":
                    squareType="sub-flag";
                    break;
                case "S":
                    squareType="sub-safe";
                    break;
                case "D":
                    squareType="sub-dead";
                    break;
                case "W":
                    squareType="sub-wrong";
                    break;
                case "R":
                    squareType="sub-right";
                    break;
                case "U":
                    squareType="sub-unfound";
                    break;
                default:
                    squareType="sub-others";
            };
            this.shadow.appendChild(
                document.importNode(
                    document.getElementById(squareType).content,
                    true
                )
            );

        };
    };
});

class MineSweeper {
    constructor(name,element,w=10,h=10,m=Math.sqrt(w*h)){
        this.name = name;
        this.element = element;
        this.w = w;
        this.h = h;
        this.m = m;
        this.data = [];
        for(var i=0;i<this.h;i++){
            this.data.push([])
            for(var j=0;j<this.w;j++){
                this.data[i].push(1)
            }
        }
        this.initDom();
        this.initMap();
    }
    initDom(){
        for(var i=0;i<this.h;i++){
            for(var j=0;j<this.w;j++){
                var temp = new subSquare();
                temp.id = `${this.name}-${i}-${j}`;
                temp.i = i;
                temp.j = j;
                temp.addEventListener("click",(e,o)=>this.Handle(e,o))
                    temp.addEventListener("contextmenu",(e,o)=>this.Handle(e,o))
                this.element.appendChild(temp);
            }
            this.element.appendChild(document.createElement("br"))
        }
    }
    initMap(){
        for(var n=0;n<this.m;n++){
            var h=Math.floor(Math.random() * this.h)
            var w=Math.floor(Math.random() * this.w);
            if(!this.data[h][w]){
                n--;
                continue;
            }
            this.data[h][w]=0;
        }
    }
    /* State Table
     * 0 unsafe unflaged
     * 1 safe unflaged
     * 2 safe flaged
     * 3 unsafe flaged
     */
    Handle(e,o){
        var i = e.target.i;
        var j = e.target.j;
        var t = e.target;
        if(e.type=="click"){
            /* left click */
            switch(this.data[i][j]){
                case(0):
                    //going to die
                    break;
                case(1):
                    //open it
                    this.Flood(i,j);
                    break;
                case(2):
                    break;
                case(3):
                    break;
            }
        }else{
            /* right click */
            switch(this.data[i][j]){
                case(0):
                    //flag it
                    this.data[i][j]=3;
                    t.setAttribute("square-type","F");
                    break;
                case(1):
                    //flag it
                    this.data[i][j]=2;
                    t.setAttribute("square-type","F");
                    break;
                case(2):
                    //cancel flag
                    this.data[i][j]=1;
                    t.setAttribuite("square-type","I");
                    break;
                case(3):
                    //cancel flag
                    this.data[i][j]=0;
                    t.setAttribuite("square-type","I");
                    break;
            }
        }
        e.preventDefault();
    }
    /* State Table
     * 0 unsafe unflaged
     * 1 safe unflaged
     * 2 safe flaged
     * 3 unsafe flaged
     */
    Flood(i,j){
        var count = 0;
        if(i!=0 && j!=0           && (this.data[i-1][j-1]==1 || this.data[i-1][j-1]==3 ))count++;
        if(i!=0                   && (this.data[i-1][j]==1   || this.data[i-1][j]==3   ))count++;
        if(i!=0 && j!=this.w      && (this.data[i-1][j+1]==1 || this.data[i-1][j+1]==3 ))count++;

        if(j!=0                   && (this.data[i][j-1]==1   || this.data[i][j-1]==3   ))count++;
        if(j!=this.w              && (this.data[i][j+1]==1   || this.data[i][j+1]==3   ))count++;

        if(i!=this.h && j!=0      && (this.data[i+1][j-1]==1 || this.data[i+1][j-1]==3 ))count++;
        if(i!=this.h              && (this.data[i+1][j]==1   || this.data[i+1][j]==3   ))count++;
        if(i!=this.h && j!=this.w && (this.data[i+1][j+1]==1 || this.data[i+1][j+1]==3 ))count++;

        if(count == 0){
            document.getElementById(`${this.name}-${i}-${j}`).setAttribute("square-type","S");
        }else{
            document.getElementById(`${this.name}-${i}-${j}`).setAttribute("square-type",count);
        }
    }
};

        </script>
    </head>
    <body>

        <!-- squareType="I(nit),F(lag),S(afe),D(ead),W(rong),R(ight),U(nfound),1,2,3,4..." -->
        <template id="sub-init">
            <span><svg width="20px" height="20px" xmlns="http://www.w3.org/2000/svg" version="1.1">
                           <rect width="20" height="20"
                             style="fill:rgb(255,250,250);
                             stroke-width:1;
                             stroke:rgb(0,0,0)"/>
                     </svg></span>
        </template>

        <template id="sub-flag">
            <span> flag </span>
        </template>

        <template id="sub-safe">
            <span><svg width="20px" height="20px" xmlns="http://www.w3.org/2000/svg" version="1.1">
                      <path d="M 0 0 l 20 0" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 0 0 l 0 20" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 0 20 l 20 0" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 20 0 l 0 20" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 0 0 l 5 5 l 0 10 l -5 5" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 5 5 l 10 0 l 5 -5" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 5 15 l 10 0 l 5 5" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      <path d="M 15 15 l 0 -10" stroke="black" stroke-width='1' fill="rgb(255,250,250)" />
                      </svg>
                      </span>
        </template>

        <template id="sub-dead">
            <span></span>
        </template>

        <template id="sub-wrong">
            <div> wrong </div>
        </template>

        <template id="sub-right">
            <div> right </div>
        </template>

        <template id="sub-unfound">
            <div> unfound </div>
        </template>

        <template id="sub-others">
            <span> <content/> </span>
        </template>

        <main-div>
            <content-div id="contentDiv">
            </content-div>
        </main-div>

        <script>
var game = new MineSweeper("game",document.getElementById('contentDiv'));
        </script>
    </body>
</html>
